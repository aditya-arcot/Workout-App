name: Deploy Application

on:
    workflow_dispatch:
    push:
        branches:
            - stage
            - main
        paths:
            - .github/workflows/deploy*.yml
            - client/src/**
            - client/Dockerfile
            - client/nginx.conf'
            - client/package-lock.json
            - client/package.json
            - client/tsconfig.*json
            - client/vite.config.ts
            - config/**
            - server/app/**
            - server/alembic.ini
            - server/Dockerfile
            - server/pyproject.toml
            - server/uv.lock

concurrency:
    group: deploy-${{ github.ref_name }}
    cancel-in-progress: true

permissions:
    contents: none

jobs:
    deploy:
        runs-on: self-hosted
        environment: ${{ github.ref_name == 'main' && 'prod' || github.ref_name }}
        steps:
            - name: create tag
              run: |
                  VERSION=${{ github.run_number }}-${{ github.run_attempt }}-${{ github.run_id }}
                  echo "TAG=$(date +%Y-%m-%d).$VERSION" >> $GITHUB_ENV

            - name: unlock keychain
              run: security unlock-keychain -p ${{ secrets.KEYCHAIN_PASSWORD }} login.keychain

            - name: checkout
              uses: actions/checkout@v6

            - name: client - setup node
              uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  check-latest: true

            - name: client - install deps & build
              working-directory: client
              run: |
                  npm config ls
                  npm ci --cache .npm
                  npm run build

            - name: client - build & push docker image
              working-directory: client
              run: |
                  IMAGE=${{secrets.DOCKER_REGISTRY}}/${{ vars.PROJECT }}-${{ vars.ENV}}-client:${{ env.TAG }}
                  docker build \
                    --build-arg VITE_API_URL=https://api-${{ secrets.DOMAIN }} \
                    -t $IMAGE .
                  docker push $IMAGE

            - name: server - setup uv
              uses: astral-sh/setup-uv@v7
              with:
                  working-directory: server
                  enable-cache: true
                  cache-python: true

            - name: server - install deps
              working-directory: server
              run: uv sync

            # TODO create .env file

            - name: server - build & push docker image
              working-directory: server
              run: |
                  IMAGE=${{secrets.DOCKER_REGISTRY}}/${{ vars.PROJECT }}-${{ vars.ENV}}-server:${{ env.TAG }}
                  docker build -t $IMAGE .
                  docker push $IMAGE

            - name: start containers
              working-directory: config/infra
              run: docker-compose -f docker-compose.yml up -d

            - name: client - remove cache folder
              if: always()
              working-directory: client
              run: rm -rf .npm

            - name: server - remove cache folder
              if: always()
              working-directory: server
              run: rm -rf .uv
