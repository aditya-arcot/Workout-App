services:
    database:
        restart: no
        ports:
            - '${POSTGRES_PORT?}:5432'

    pg-admin:
        restart: no
        ports:
            - 8081:80

        labels:
            - traefik.http.routers.${PROJECT?}-${ENV?}-pg-admin.rule=Host(`db.${DOMAIN?}`)
            - traefik.http.routers.${PROJECT?}-${ENV?}-pg-admin.entrypoints=web

    mailcatcher:
        image: dockage/mailcatcher:0.9.0
        container_name: ${PROJECT?}-${ENV?}-mailcatcher
        restart: no
        ports:
            - '1080:1080' # web ui
            - '1025:1025' # smtp

    server:
        pull_policy: build
        build:
            context: ../../server

        restart: no
        ports:
            - '8000:8000'

        # binds to all interfaces
        command: fastapi run --reload app/main.py

        develop:
            watch:
                - path: ../../server
                  action: sync
                  target: /src
                - path: ../../server/.dockerignore
                  action: rebuild
                - path: ../../server/Dockerfile
                  action: rebuild
                - path: ../../server/pyproject.toml
                  action: rebuild
                - path: ../../server/uv.lock
                  action: rebuild

        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'python -c "import urllib.request; urllib.request.urlopen(''http://server:8000/api/health'')"',
                ]

        labels:
            - traefik.http.routers.${PROJECT?}-${ENV?}-server.rule=Host(`api.${DOMAIN?}`)
            - traefik.http.routers.${PROJECT?}-${ENV?}-server.entrypoints=web

    client:
        pull_policy: build
        build:
            context: ../../client
            target: dev

        restart: no
        ports:
            - '5173:5173'

        environment:
            - VITE_API_URL=http://localhost:8000

        develop:
            watch:
                - path: ../../client
                  target: /src
                  action: sync
                - path: ../../client/.dockerignore
                  action: rebuild
                - path: ../../client/Dockerfile
                  action: rebuild
                - path: ../../client/package.json
                  action: rebuild
                - path: ../../client/package-lock.json
                  action: rebuild
                - path: ../../client/vite.config.ts
                  action: rebuild

        labels:
            - traefik.http.routers.${PROJECT?}-${ENV?}-client.entrypoints=web
